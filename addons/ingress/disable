#!/usr/bin/env bash

set -e

NAMESPACE="ingress"
GW_VERSION="v1.4.0"

function usage {
    echo "Usage: microk8s disable ingress [OPTIONS]"
    echo ""
    echo "Disable the Traefik ingress controller addon."
    echo ""
    echo "   -h               Print this help message"
}

while getopts ":h" arg; do
    case "${arg}" in
        h)
            usage
            exit 0
            ;;
        ?)
            echo "Invalid option -${OPTARG}"
            usage
            exit 1
            ;;
    esac
done

HELM="$SNAP/microk8s-helm3.wrapper"
KUBECTL="$SNAP/microk8s-kubectl.wrapper"

echo "Disabling Traefik ingress controller"

# Clean up legacy nginx-ingress resources (for users upgrading from old versions)
echo "Cleaning up legacy nginx-ingress resources..."
$KUBECTL delete deployment -n default default-http-backend 2>/dev/null || true
$KUBECTL delete service -n default default-http-backend 2>/dev/null || true
$KUBECTL delete serviceaccount -n default nginx-ingress-microk8s-serviceaccount 2>/dev/null || true
$KUBECTL delete role -n default nginx-ingress-microk8s-role 2>/dev/null || true
$KUBECTL delete rolebinding -n default nginx-ingress-microk8s 2>/dev/null || true
$KUBECTL delete configmap -n default nginx-load-balancer-microk8s-conf 2>/dev/null || true
$KUBECTL delete daemonset -n default nginx-ingress-microk8s-controller 2>/dev/null || true
$KUBECTL delete daemonset -n ingress nginx-ingress-microk8s-controller 2>/dev/null || true

# Uninstall Traefik
echo "Uninstalling Traefik..."
$HELM uninstall traefik -n "${NAMESPACE}" 2>/dev/null || true

# Delete Gateway API CRDs
echo "Removing Gateway API CRDs..."
$KUBECTL delete -f "https://github.com/kubernetes-sigs/gateway-api/releases/download/${GW_VERSION}/standard-install.yaml" 2>/dev/null || true

# Clean up Traefik CRDs
echo "Cleaning up Traefik CRDs..."
$KUBECTL get crd -o name 2>/dev/null | grep "traefik.io" | xargs -r $KUBECTL delete 2>/dev/null || true

# Delete ingress namespace
echo "Removing ingress namespace..."
$KUBECTL delete namespace "${NAMESPACE}" 2>/dev/null || true

echo "Ingress is disabled"
